<div data-role="page" class="routes-new">
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
       
        var directionDisplay;
	var directionsService = new google.maps.DirectionsService();
       
	var ewktFunction = function() {
		
		var points;
		var geography;
		
		function constructor(type){
			points = '';
			geography = type;
		}
		
		function addPoint(lat, lng) {
			points = points.concat(lng);
			points = points.concat(' ');
			points = points.concat(lat);
			points = points.concat(',');
		}
		
		function toEWKT() {

			var ewkt = '';
			if (geography == "POINT"){
				ewkt = 'SRID=4236;POINT(' + points.slice(0,-1) + ')';
			}
			else if (geography == "LINESTRING"){
				ewkt = 'SRID=4236;LINESTRING(' + points.slice(0,-1) + ')';
			}
			
			return ewkt;
		}
		
		return{
			constructor: constructor,
			addPoint: addPoint,
			toEWKT: toEWKT
		}
	}();
	
	var routeInformation = function() {

		function constructor(result){

			var routeArray = new Array(); 

			for(var r=0; r < result.routes.length; r++) {

				var route = result.routes[r];
				ewktFunction.constructor("LINESTRING");
				for(var i=0; i < route.overview_path.length; i++) {
					ewktFunction.addPoint(String(route.overview_path[i].lat()),String(route.overview_path[i].lng()));
				}
				var overviewPathEWKT = ewktFunction.toEWKT();
				
				var legsArray = new Array();
				for(var l=0; l < route.legs.length; l++) {
					var leg = route.legs[l];
					var stepsArray = new Array();
					for (var s=0; s < leg.steps.length;s++){

						ewktFunction.constructor("LINESTRING");
						for (var i=0; i < leg.steps[s].path.length;i++){
							ewktFunction.addPoint(String(leg.steps[s].path[i].lat()),String(leg.steps[s].path[i].lng()));
						}
						stepsArray[s] = leg.steps[s].distance.text + "<step>" + leg.steps[s].duration.text + "<step>" + leg.steps[s].end_location + "<step>" + leg.steps[s].instructions + "<step>" + leg.steps[s].start_location + "<step>" + ewktFunction.toEWKT();
					}

				legsArray[l] = stepsArray.join("<steps>");
				}
			routeArray[r] = route.copyrights + "<route>" + overviewPathEWKT + "<route>" + legsArray.join("<legs>");
			}							
			
			
			document.getElementById("description").value = routeArray.join("<routes>") + "<routes>";
			document.getElementById("routes_geo").value = routeArray.join("<routes>") + "<routes>";
		}

		return{
			constructor: constructor
		}
    	}();
  
    	$('#new_route').submit(function() {
    	    		
	     	var start = document.getElementById("route_begin_text").value;
	     	var end = document.getElementById("route_end_text").value;
	     
	     	var request = {
	     	origin:start, 
	     	destination:end,
	     	travelMode: google.maps.DirectionsTravelMode.BICYCLING 
	     	};
	     	
	     	directionsService.route(request, function(response, status) {
	     		if (status == google.maps.DirectionsStatus.OK) {
	     		directionsDisplay.setDirections(response);
	     		}
		});
		
		alert ("3");
	});
        
        
     	$('.routes-new').live("pagecreate", function() {
     		    		
     		    	
		directionsDisplay = new google.maps.DirectionsRenderer();
		google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
		routeInformation.constructor(directionsDisplay.directions);
		});          
	});

	$('.routes-new').live('pageshow',function(){
	alert ("3");	
	
		document.getElementById("route_name").value = "R100";
		document.getElementById("route_begin_text").value = "1305 Delbruck Ave, North Vancouver, BC";
		document.getElementById("route_end_text").value = "4330 Kingsway, Burnaby, BC";
		document.getElementById("routes_geo").value = "xxxxxxx";
		
        });

    </script> 

<div data-role="content">


<%= render 'partials/header' %>
    
<%= render 'partials/user_information' %>

<ul data-role="listview" class="ui-listview ui-listview-inset ui-corner-all ui-controlgroup ui-controlgroup-vertical ui-shadow">
<%= render 'partials/my_commutes' %>
<% @routes.each do |route| %>
<li>
<%= link_to route.name, user_route_path(current_user.id,route) %>
</li>
<% end %>

<li data-role="list-divider">New Commute</li>
</ul>

<div class="ui-body ui-body-c">
<%= form_for [@user, @route] do |f| %>

<div data-role="fieldcontain">
    <%= image_tag "route_name.png" %>
    <%= f.text_field :name, :id => "route_name" %>
</div>

<div data-role="fieldcontain">
	<%= image_tag "A.png" %>
	<%= f.text_field :begin_text, :id => "route_begin_text" %>
	
	<div data-role="controlgroup" data-type="horizontal" >
		<a data-role="button" data-iconpos="notext" data-icon="delete"></a>
	    	<a data-role="button" data-iconpos="notext" data-icon="arrow-d"></a>

	</div>
</div>

<div data-role="fieldcontain">
    <%= image_tag "B.png" %>
    <%= f.text_field :end_text , :id => "route_end_text"%>
    
    	<div data-role="controlgroup" data-type="horizontal" >
    	    <a data-role="button" data-iconpos="notext" data-icon="delete"></a>
    	    <a data-role="button" data-iconpos="notext" data-icon="arrow-u"></a>
	</div>
</div>

<%=  hidden_field_tag :routes_geo, params['routes_geo'] %>

<div data-role="controlgroup" data-type="horizontal">

<button id="directions_get" type="button">D</button>

<%= f.submit :"Save" %>

</div>
<% end %>
</div>

<%= render 'partials/world' %>
</div>


</div>